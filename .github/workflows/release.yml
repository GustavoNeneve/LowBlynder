name: Create Release

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# How to use:
#   1. Go to GitHub â†’ Actions â†’ "Create Release" â†’ "Run workflow"
#   2. Enter the version number (e.g.  1.0.0  â€” without the "v")
#   3. Click "Run workflow"
#
# This workflow will:
#   â€¢ Tag the latest commit on the branch as v{version}
#   â€¢ Push the tag  â†’  automatically triggers "Build Executables"
#     which builds .exe / .dmg / .AppImage and creates a GitHub Release
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (without the "v" prefix, e.g. 1.0.0)'
        required: true
        default: '1.0.0'

permissions:
  contents: write

jobs:
  tag:
    name: Tag & trigger build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version format
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "âŒ Invalid version format: '$VERSION'. Expected: MAJOR.MINOR.PATCH (e.g. 1.0.0)"
            exit 1
          fi
          echo "âœ… Version format is valid: $VERSION"

      - name: Check tag does not already exist
        run: |
          TAG="v${{ github.event.inputs.version }}"
          if git ls-remote --tags origin "$TAG" | grep -q "$TAG"; then
            echo "âŒ Tag '$TAG' already exists in the remote. Bump the version."
            exit 1
          fi
          echo "âœ… Tag '$TAG' is available"

      - name: Update version in package.json
        env:
          VERSION: ${{ github.event.inputs.version }}
        run: |
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = process.env.VERSION;
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "
          echo "âœ… package.json updated to $VERSION"

      - name: Commit version bump
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json
          git commit -m "chore: bump version to ${{ github.event.inputs.version }}" || echo "Nothing to commit"

      - name: Create and push tag
        run: |
          TAG="v${{ github.event.inputs.version }}"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin HEAD --follow-tags
          echo "ğŸš€ Tag '$TAG' pushed â€” Build Executables workflow is now running"
          echo ""
          echo "ğŸ‘‰ Track progress at:"
          echo "   https://github.com/${{ github.repository }}/actions"
          echo ""
          echo "ğŸ“¦ Release will appear at:"
          echo "   https://github.com/${{ github.repository }}/releases/tag/$TAG"
